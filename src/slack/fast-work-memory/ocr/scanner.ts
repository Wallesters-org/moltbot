/**
 * Скенер - OCR модул за извличане на текст от изображения
 *
 * Поддържа:
 * - Сканиране от камера в реално време
 * - Обработка на качени изображения
 * - Многоезична поддръжка (български, английски)
 * - Оптимизация за ниска консумация на ресурси
 */

import type { OCRОбласт, OCRРезултат } from "../models/types.js";

/** Конфигурация за OCR */
export interface OCRКонфигурация {
  /** Език за разпознаване */
  език: "bul" | "eng" | "bul+eng";
  /** Минимална увереност (0-1) */
  минУвереност: number;
  /** Предобработка на изображение */
  предобработка: boolean;
  /** Мащабиране на изображение */
  мащаб: number;
  /** Режим на работа */
  режим: "бърз" | "точен" | "балансиран";
}

/** Конфигурация по подразбиране */
const ПОДРАЗБИРАНЕ: OCRКонфигурация = {
  език: "bul+eng",
  минУвереност: 0.6,
  предобработка: true,
  мащаб: 1.0,
  режим: "балансиран",
};

/** Интерфейс за OCR двигател */
export interface OCRДвигател {
  разпознай(изображение: Buffer | string): Promise<OCRРезултат>;
  поддържаниЕзици(): string[];
  освободи(): Promise<void>;
}

/**
 * Предобработва текст от OCR
 */
function почистиТекст(текст: string): string {
  return (
    текст
      // Премахва множество интервали
      .replace(/\s+/g, " ")
      // Премахва празни редове
      .replace(/\n\s*\n/g, "\n")
      // Поправя чести OCR грешки
      .replace(/[|]/g, "I")
      .replace(/[0O]/g, (м, позиция, текст) => {
        // Опитва се да разбере от контекста дали е 0 или O
        const преди = текст[позиция - 1] || "";
        const след = текст[позиция + 1] || "";
        if (/[0-9]/.test(преди) || /[0-9]/.test(след)) return "0";
        if (/[A-ZА-Я]/.test(преди) || /[A-ZА-Я]/.test(след)) return "O";
        return м;
      })
      .trim()
  );
}

/**
 * Обединява близки области
 */
function обединиОбласти(области: OCRОбласт[], праг = 20): OCRОбласт[] {
  if (области.length <= 1) return области;

  const резултат: OCRОбласт[] = [];
  const използвани = new Set<number>();

  for (let i = 0; i < области.length; i++) {
    if (използвани.has(i)) continue;

    let текуща = { ...области[i] };
    използвани.add(i);

    for (let j = i + 1; j < области.length; j++) {
      if (използвани.has(j)) continue;

      const друга = области[j];

      // Проверява дали са близо вертикално
      const вертикалноБлизо =
        Math.abs(
          текуща.координати.y +
            текуща.координати.височина -
            друга.координати.y,
        ) < праг ||
        Math.abs(
          друга.координати.y + друга.координати.височина - текуща.координати.y,
        ) < праг;

      // Проверява дали се припокриват хоризонтално
      const хоризонталноПрипокриване =
        текуща.координати.x <
          друга.координати.x + друга.координати.ширина + праг &&
        друга.координати.x <
          текуща.координати.x + текуща.координати.ширина + праг;

      if (вертикалноБлизо && хоризонталноПрипокриване) {
        // Обединява областите
        const минX = Math.min(текуща.координати.x, друга.координати.x);
        const минY = Math.min(текуща.координати.y, друга.координати.y);
        const максX = Math.max(
          текуща.координати.x + текуща.координати.ширина,
          друга.координати.x + друга.координати.ширина,
        );
        const максY = Math.max(
          текуща.координати.y + текуща.координати.височина,
          друга.координати.y + друга.координати.височина,
        );

        текуща = {
          координати: {
            x: минX,
            y: минY,
            ширина: максX - минX,
            височина: максY - минY,
          },
          текст: текуща.текст + " " + друга.текст,
          увереност: (текуща.увереност + друга.увереност) / 2,
        };

        използвани.add(j);
      }
    }

    резултат.push(текуща);
  }

  return резултат;
}

/**
 * Симулиран OCR двигател (за тестове и демо)
 * В продукция се заменя с Tesseract.js или друг OCR двигател
 */
function създайСимулиранДвигател(): OCRДвигател {
  return {
    async разпознай(_изображение: Buffer | string): Promise<OCRРезултат> {
      // Симулиран резултат за демо
      return {
        текст: "",
        увереност: 0,
        език: "bul",
        области: [],
        времеЗаОбработка: 0,
      };
    },
    поддържаниЕзици() {
      return ["bul", "eng", "bul+eng"];
    },
    async освободи() {
      // Няма ресурси за освобождаване
    },
  };
}

/**
 * Създава Скенер инстанция
 */
export function създайСкенер(
  двигател?: OCRДвигател,
  конфиг: Partial<OCRКонфигурация> = {},
) {
  const настройки: OCRКонфигурация = { ...ПОДРАЗБИРАНЕ, ...конфиг };
  const ocrДвигател = двигател ?? създайСимулиранДвигател();

  // Статистика
  let общоСканирания = 0;
  let успешниСканирания = 0;
  let общоВреме = 0;

  return {
    /**
     * Сканира изображение и извлича текст
     */
    async сканирай(изображение: Buffer | string): Promise<OCRРезултат> {
      const началоВреме = Date.now();
      общоСканирания++;

      try {
        const резултат = await ocrДвигател.разпознай(изображение);

        // Филтрира по увереност
        const филтрираниОбласти = резултат.области.filter(
          (о) => о.увереност >= настройки.минУвереност,
        );

        // Обединява близки области
        const обединени = обединиОбласти(филтрираниОбласти);

        // Почиства текста
        const почистенТекст = почистиТекст(резултат.текст);

        const времеЗаОбработка = Date.now() - началоВреме;
        общоВреме += времеЗаОбработка;

        if (почистенТекст.length > 0) {
          успешниСканирания++;
        }

        return {
          текст: почистенТекст,
          увереност: резултат.увереност,
          език: резултат.език,
          области: обединени,
          времеЗаОбработка,
        };
      } catch (грешка) {
        return {
          текст: "",
          увереност: 0,
          език: настройки.език,
          области: [],
          времеЗаОбработка: Date.now() - началоВреме,
        };
      }
    },

    /**
     * Сканира от URL на изображение
     */
    async сканирайОтURL(url: string): Promise<OCRРезултат> {
      try {
        const отговор = await fetch(url);
        if (!отговор.ok) {
          throw new Error(`Грешка при зареждане: ${отговор.status}`);
        }

        const буфер = Buffer.from(await отговор.arrayBuffer());
        return this.сканирай(буфер);
      } catch (грешка) {
        return {
          текст: "",
          увереност: 0,
          език: настройки.език,
          области: [],
          времеЗаОбработка: 0,
        };
      }
    },

    /**
     * Сканира множество изображения паралелно
     */
    async сканирайМного(
      изображения: (Buffer | string)[],
    ): Promise<OCRРезултат[]> {
      const резултати = await Promise.all(
        изображения.map((изобр) => this.сканирай(изобр)),
      );
      return резултати;
    },

    /**
     * Връща поддържани езици
     */
    поддържаниЕзици(): string[] {
      return ocrДвигател.поддържаниЕзици();
    },

    /**
     * Променя език
     */
    сменяЕзик(език: "bul" | "eng" | "bul+eng"): void {
      настройки.език = език;
    },

    /**
     * Променя режим на работа
     */
    сменяРежим(режим: "бърз" | "точен" | "балансиран"): void {
      настройки.режим = режим;

      switch (режим) {
        case "бърз":
          настройки.минУвереност = 0.5;
          настройки.предобработка = false;
          break;
        case "точен":
          настройки.минУвереност = 0.8;
          настройки.предобработка = true;
          break;
        case "балансиран":
        default:
          настройки.минУвереност = 0.6;
          настройки.предобработка = true;
      }
    },

    /**
     * Връща статистика
     */
    статистика() {
      return {
        общоСканирания,
        успешниСканирания,
        успеваемост:
          общоСканирания > 0
            ? Math.round((успешниСканирания / общоСканирания) * 100)
            : 0,
        средноВреме:
          общоСканирания > 0 ? Math.round(общоВреме / общоСканирания) : 0,
        текущРежим: настройки.режим,
        текущЕзик: настройки.език,
      };
    },

    /**
     * Нулира статистиката
     */
    нулирайСтатистика(): void {
      общоСканирания = 0;
      успешниСканирания = 0;
      общоВреме = 0;
    },

    /**
     * Освобождава ресурси
     */
    async освободи(): Promise<void> {
      await ocrДвигател.освободи();
    },
  };
}

export type Скенер = ReturnType<typeof създайСкенер>;
